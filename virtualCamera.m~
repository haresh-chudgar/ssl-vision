%tP = [-2629.94; -1288.02; 1268];
tP = [-1800.43; -1261.71; 1220];

% q0P = 0.00101674;
% q1P = 0.998912;
% q2P = -0.0136203;
% q3P = 0.044595;

% q0P = 0.684316;
% q1P = -0.272381;
% q2P = 0.217458;
% q3P = -0.640311;
q0P 0.932441 q1P -0.326171 q2P 0.0467859 q3P -0.0444637

q0P = 0.932441;
q1P = -0.326171;
q2P = 0.0467859;
q3P = -0.644914;

rotMP = [(1 - 2*(q1P * q1P + q2P * q2P)) 2*(q0P*q1P - q2P*q3P)           2*(q0P*q2P+q1P*q3P);
        2*(q0P*q1P + q2P*q3P)           (1 - 2*(q0P * q0P + q2P * q2P)) 2*(q1P*q2P-q0P*q3P)
        2*(q0P*q2P - q1P*q3P)           2*(q0P*q3P + q1P*q2P)           (1 - 2*(q1P * q1P + q0P * q0P))];
    
q0 = -q0P;
q1 = -q1P;
q2 = -q2P;
q3 = q3P;

t = (0 - tP);
t(1) = (1 - 2*(q1 * q1 + q2 * q2)) * -tP(1) + 2*(q0*q1 - q2*q3) * -tP(2) + 2*(q0*q2+q1*q3)*-tP(3);
t(2) = 2*(q0*q1 + q2*q3) * -tP(1) +  (1 - 2*(q0 * q0 + q2 * q2)) * -tP(2) + 2*(q1*q2-q0*q3)*-tP(3);
t(3) = 2*(q0*q2 - q1*q3) * -tP(1) + 2*(q0*q3 + q1*q2) * -tP(2) + (1 - 2*(q1 * q1 + q0 * q0))*-tP(3);

focalX = 217.821;
focalY = 23.369;
principalPoint = [390; 290];

%fieldPoints = [4490,-4490,-4490,4490,4490,-4490,0,0; 2995,2995,-2995,-2995,0,0,2995,-2995; 0,0,0,0,0,0,0,0];
fieldPoints = [4490,-4490,-4490,4490,4490,-4490,0,0,4490,0; 2995,2995,-2995,-2995,0,0,2995,-2995,0,0; 0,0,0,0,0,0,0,0,0,0];
nPoints = size(fieldPoints);
nPoints = nPoints(2);

t = repmat(t, 1, nPoints);
rotM = [(1 - 2*(q1 * q1 + q2 * q2)) 2*(q0*q1 - q2*q3)           2*(q0*q2+q1*q3);
        2*(q0*q1 + q2*q3)           (1 - 2*(q0 * q0 + q2 * q2)) 2*(q1*q2-q0*q3)
        2*(q0*q2 - q1*q3)           2*(q0*q3 + q1*q2)           (1 - 2*(q1 * q1 + q0 * q0))];
imagePoints = rotM * fieldPoints;
imagePoints = imagePoints + t;
cameraPoints = imagePoints;

figure;
axis image
x = [cameraPoints(1,1),cameraPoints(1,2),cameraPoints(1,3),cameraPoints(1,4),cameraPoints(1,5),cameraPoints(1,10),cameraPoints(1,7),cameraPoints(1,10);
     cameraPoints(1,2),cameraPoints(1,3),cameraPoints(1,4),cameraPoints(1,1),cameraPoints(1,10),cameraPoints(1,6),cameraPoints(1,10),cameraPoints(1,8)];
y = [cameraPoints(2,1),cameraPoints(2,2),cameraPoints(2,3),cameraPoints(2,4),cameraPoints(2,5),cameraPoints(2,10),cameraPoints(2,7),cameraPoints(2,10);
     cameraPoints(2,2),cameraPoints(2,3),cameraPoints(2,4),cameraPoints(2,1),cameraPoints(2,10),cameraPoints(2,6),cameraPoints(2,10),cameraPoints(2,8)];
z = [cameraPoints(3,1),cameraPoints(3,2),cameraPoints(3,3),cameraPoints(3,4),cameraPoints(3,5),cameraPoints(3,10),cameraPoints(3,7),cameraPoints(3,10);
     cameraPoints(3,2),cameraPoints(3,3),cameraPoints(3,4),cameraPoints(3,1),cameraPoints(3,10),cameraPoints(3,6),cameraPoints(3,10),cameraPoints(3,8)];
subplot(1,3,1);
plot3(x(:,1),y(:,1),z(:,1),'r', x(:,2),y(:,2),z(:,2),'g', x(:,3),y(:,3),z(:,3),'b',x(:,4),y(:,4),z(:,4),'k', x(:,5),y(:,5), z(:,5),'b--o', x(:,6),y(:,6), z(:,6),'b--o', x(:,7),y(:,7), z(:,7),'r--o', x(:,8),y(:,8), z(:,8),'r--o');

% for index=1:nPoints
%    imagePoints(:,index) =  imagePoints(:,index) / imagePoints(3,index);
% end
zMatrix = zeros(nPoints, nPoints);
for index=1:nPoints
    zMatrix(index,index) = imagePoints(3,index);
end
imagePoints = [focalX 0;0 focalY] * imagePoints(1:2,:) + repmat(principalPoint,1,nPoints) * zMatrix;
 for index=1:nPoints
    imagePoints(:,index) =  imagePoints(:,index) / zMatrix(index,index);
 end
subplot(1,3,2);
imagePoints(2,3) = -imagePoints(2,3);
imagePoints(2,8) = -imagePoints(2,8);
imagePoints(1,8) = -imagePoints(1,8);
imagePoints(1,6) = -imagePoints(1,6);
imagePoints(2,6) = -imagePoints(2,6);
x = [imagePoints(1,1),imagePoints(1,2),imagePoints(1,3),imagePoints(1,4),imagePoints(1,5),imagePoints(1,10),imagePoints(1,7), imagePoints(1,10);
     imagePoints(1,2),imagePoints(1,3),imagePoints(1,4),imagePoints(1,1),imagePoints(1,10),imagePoints(1,6),imagePoints(1,10), imagePoints(1,8)];
y = [imagePoints(2,1),imagePoints(2,2),imagePoints(2,3),imagePoints(2,4),imagePoints(2,5),imagePoints(2,10),imagePoints(2,7), imagePoints(2,10);
     imagePoints(2,2),imagePoints(2,3),imagePoints(2,4),imagePoints(2,1),imagePoints(2,10),imagePoints(2,6),imagePoints(2,10), imagePoints(2,8)];
plot(x(:,1),y(:,1),'r', x(:,2),y(:,2),'g', x(:,3),y(:,3),'b',x(:,4),y(:,4),'k', x(:,5),y(:,5),'b--o', x(:,6),y(:,6),'b--o', x(:,7),y(:,7),'r--o', x(:,8),y(:,8),'r--o');
set(gca,'XAxisLocation','top','YAxisLocation','left','ydir','reverse');

y = [4490,-4490,-4490,4490,4490,0;-4490,-4490,4490,4490,-4490,0];
x = [2995,2995,-2995,-2995,0,2995;2995,-2995,-2995,2995,0,-2995];
subplot(1,3,3);
plot(x(:,1),y(:,1),'r', x(:,2),y(:,2),'g', x(:,3),y(:,3),'b',x(:,4),y(:,4),'k', x(:,5),y(:,5), 'b--o', x(:,6),y(:,6), 'r--o')
set(gca,'xdir', 'reverse');
